---
  - name: Apply Windows Updates
    hosts: win
    become: true
    become_method: runas
    become_user: SYSTEM

    tasks:

    - name: Check for Missing Windows Updates
      win_updates: 
        state=searched
      register: missing_updates
      tags:
      - check
      - update

    - name: Print Missing Windows Updates
      debug:
        var: missing_updates 
      tags:
      - check
      - update

    - name: Install All Windows Updates
      win_updates:
        category_names: '*'
        reboot: true
        reboot_timeout: 3600
      register: update_results
      tags:
      - update

    - name: Windows Update Results 
      debug:
        var: update_results
      tags:
      - update

    - name: Reboot Windows VMs If Needed
      win_reboot:
      when: update_result.reboot_required
      tags:
      - update
      - reboot
